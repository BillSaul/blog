---
title: ä»é›¶å¼€å§‹çš„ All In One
categories: 
  - All In One
tags: 
  - Linux
  - PVE
  - OpenWrt
  - SSH
  - SSL
  - fail2ban
meta: 
  - 
    name: description
    content: ä»é›¶å¼€å§‹çš„ All In One
  - 
    name: keywords
    content: Linux,PVE,OpenWrt,SSH,SSL,fail2ban,all-in-one,è½¯è·¯ç”±,è™šæ‹Ÿæœº
date: 2024-06-14 13:48:32
permalink: /pages/cec9e0/
---



æˆ‘çš„All in oneå°ä¸»æœºæ˜¯åº·è€ä¿¡çš„n100ï¼Œæœ‰å››ä¸ªç½‘å£ï¼ŒETH0ã€ETH1ã€ETH2å‡†å¤‡ç›´é€šåˆ°OpenWrtä¸­ï¼ŒETH3ä½œä¸ºPVEçš„ç®¡ç†å£ã€‚

> çœ‹å‰æç¤ºï¼šæœ¬æ•™ç¨‹éœ€è¦ä½ ä¼šä¸€ç‚¹ Linux åŸºç¡€ï¼Œä»…ä»…æ˜¯å¯¹æˆ‘è¿™æ¬¡æŠ˜è…¾çš„ä¸€æ¬¡è®°å½•ï¼Œä¸å¤ªé€‚åˆå°ç™½ç”¨æˆ·ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªå¤§è‡´çš„ç½‘ç»œæ‹“è¡¥å›¾

![ç½‘ç»œæ‹“æ‰‘](~public/assets/page-img/2024/20240613/1.svg)

## 1. å®‰è£…PVE

### 1.1 å®‰è£…

å‡†å¤‡å·¥ä½œï¼š

- ä¸€ä¸ªUç›˜ï¼ˆæ³¨æ„ä¼šè¢«æ ¼å¼åŒ–ï¼‰
- ä¸‹è½½PVEé•œåƒï¼Œ[ä¸‹è½½åœ°å€](https://www.proxmox.com/en/downloads)
- ä¸‹è½½çƒ§å½•è½¯ä»¶ï¼Œæˆ‘ç”¨çš„æ˜¯[balenaEtcher](https://etcher.balena.io/)

å¼€å§‹å®‰è£…pveï¼šå…·ä½“è¿‡ç¨‹å‚è€ƒè¿™ä¸ªBç«™è§†é¢‘ ğŸ‘‰ [ã€åˆ©ç”¨PVEè™šæ‹Ÿæœºï¼Œæ¥æ‰“é€ å±äºè‡ªå·±çš„All In Oneç³»ç»Ÿå§ï¼ã€‘ ã€ç²¾å‡†ç©ºé™åˆ° 02:06ã€‘](https://www.bilibili.com/video/BV1bc411v7A3/?t=126)

~~è§†é¢‘æ•™ç¨‹æ›´åŠ æ¸…æ™°æ˜äº†ï¼Œå¹¶ä¸æ˜¯å› ä¸ºæˆ‘æ‡’å¾—å†™å›¾æ–‡æ•™ç¨‹~~

<strong style='color: red'>âš ï¸æ³¨æ„ï¼šåœ¨è§†é¢‘çš„ [03:54](https://www.bilibili.com/video/BV1bc411v7A3/?share_source=copy_web&vd_source=aa6661a4ed1c3838fa877ec35742b580&t=234)Â å¤„ï¼Œè¿™é‡Œçš„DNS Server è¦å¡«ä¸€ä¸ªæœ‰æ•ˆçš„DNSæœåŠ¡å™¨ï¼Œä¸ç„¶åé¢PVEæ¥å…¥OpenWrtåè¿˜æ˜¯ä¸Šä¸äº†ç½‘ï¼Œæˆ‘è¿™é‡Œå¡«çš„Â 223.5.5.5</strong>

çœ‹åˆ° <strong style='color: deepskyblue'>5åˆ†23ç§’</strong> å¤„å³å¯ç»“æŸï¼Œå› ä¸ºæˆ‘åé¢è¦ç›´é€šç½‘å¡åˆ°OpenWrtã€‚

### 1.2 é…ç½®

#### 1.2.1 é…ç½®ssh

ç”¨ vim ç¼–è¾‘ `vim /etc/ssh/sshd_config` ï¼Œä¿®æ”¹ä¸‹é¢çš„å‡ ä¸ªé…ç½®ï¼š

```ssh
PasswordAuthentication no
PermitEmptyPasswords no
X11Forwarding no
PubkeyAuthentication yes
```

è¿›å…¥ `/root/.ssh` ç›®å½•ï¼Œé‡Œé¢æœ‰ `id_rsa` æ–‡ä»¶ï¼Œä¸‹è½½åˆ°æœ¬åœ°ã€‚

è¿™æ ·é…ç½®å®Œæˆä¹‹åï¼Œpveçš„sshå°±ç¦æ­¢ä½¿ç”¨å¯†ç ç™»å½•ï¼Œåªèƒ½ä½¿ç”¨å¯†é’¥è¿æ¥äº†ã€‚

#### 1.2.2 é…ç½®fail2ban

å®‰è£…fail2banä¸ºsshå’Œpveç®¡ç†åå°ç™»å½•å¼€å¯ç™»å½•ä¿æŠ¤ã€‚

```shell
apt update
apt install fail2ban
```

åˆ°è¿™é‡Œä¼šå‘ç°ï¼Œå®‰è£…äº†fail2banä¹‹åï¼Œfail2banæ— æ³•å¯åŠ¨ï¼Œå› ä¸º Debian12 çš„ç¼˜æ•…ï¼Œéœ€è¦è°ƒæ•´ä¸€ä¸ªåœ°æ–¹çš„è®¾ç½®ã€‚

åˆ›å»ºä¸€ä¸ª `jail.local` æ–‡ä»¶ï¼š

```shell
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
```

æ ¹æ®è¿™ä¸ª [https://github.com/fail2ban/fail2ban/issues/3292#issuecomment-1142503461](https://github.com/fail2ban/fail2ban/issues/3292#issuecomment-1142503461) æ¥è®¾ç½®ä¸€ä¸‹ï¼Œç„¶åæ‰§è¡Œ `systemctl restart fail2ban` å°±å¯ä»¥äº†ã€‚

ç„¶åé…ç½®fail2banä¸ºåå°ç®¡ç†å¼€å¯ç™»å½•ä¿æŠ¤ï¼š

ç¼–è¾‘ `/etc/fail2ban/jail.local` æ–‡ä»¶åœ¨æ–‡ä»¶æœ«å°¾å†™å…¥ï¼š

```
[proxmox]
enabled = true
port = https,http,8006
filter = proxmox
backend = systemd
maxretry = 3
findtime = 2d
bantime = 1h
```

åœ¨ç”¨vimç¼–è¾‘ `vim /etc/fail2ban/filter.d/proxmox.conf` ï¼Œå†™å…¥ï¼š

```
[Definition]
failregex = pvedaemon\[.*authentication failure; rhost=<HOST> user=.* msg=.*
ignoreregex =
journalmatch = _SYSTEMD_UNIT=pvedaemon.service
```

æœ€åæ‰§è¡Œï¼š

```
systemctl restart fail2ban
```

## 2. å®‰è£…OpenWrt

æˆ‘ç”¨çš„æ˜¯ koolcenter ç¼–è¯‘çš„ [iStoreOS](https://fw.koolcenter.com/iStoreOS/) ï¼Œé€‰æ‹©ä½ ä¸»æœºå¯¹åº”çš„ç³»ç»Ÿæ¶æ„çš„é•œåƒä¸‹è½½ï¼Œæˆ‘é€‰çš„æ˜¯ `x86_64_efi` ã€‚

é¦–å…ˆåœ¨PVEä¸­åˆ›å»ºOpenWrtè™šæ‹Ÿæœºï¼Œå‚è€ƒè§†é¢‘ä¾æ—§æ˜¯ä¸Šé¢é‚£ä¸ªè§†é¢‘ ğŸ‘‰ [ã€åˆ©ç”¨PVEè™šæ‹Ÿæœºï¼Œæ¥æ‰“é€ å±äºè‡ªå·±çš„All In Oneç³»ç»Ÿå§ï¼ã€‘ ã€ç²¾å‡†ç©ºé™åˆ° 05:47ã€‘](https://www.bilibili.com/video/BV1bc411v7A3/?t=347)

<strong style='color: red'>âš ï¸æ³¨æ„ï¼šæœ¬æ¬¡æ•™ç¨‹æˆ‘ä»¬ç”¨ä¸åˆ° "img2kvm" è¿™ä¸ªè„šæœ¬ï¼Œåªéœ€è¦ä¸Šä¼ é•œåƒæ–‡ä»¶å³å¯ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å‘½ä»¤ä¹Ÿèƒ½åšåˆ°åŒæ ·çš„æ•ˆæœ</strong>

å°†é•œåƒæ–‡ä»¶ä¸Šä¼ åˆ°pveä¸­åæˆ‘ä»¬æ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š

```shell
qm importdisk <ä½ çš„è™šæ‹Ÿæœºid> <ä¸Šä¼ çš„é•œåƒè·¯å¾„> local-lvm
```

å¯¼å…¥æˆåŠŸåï¼Œç»§ç»­æŒ‰ç…§è§†é¢‘ä¸­çš„æ•™ç¨‹è®¾ç½®è™šæ‹Ÿç£ç›˜å’Œå¯åŠ¨é¡ºåºã€‚

## 3. OpenWrtä¸­å®‰è£…OpenClash

### 3.1 å®‰è£…

å®‰è£…æ‰€éœ€ä¾èµ–

```shell
opkg update && opkg install coreutils-nohup bash iptables dnsmasq-full curl ca-certificates ipset ip-full iptables-mod-tproxy iptables-mod-extra libcap libcap-bin ruby ruby-yaml kmod-tun kmod-inet-diag unzip luci-compat luci luci-base
```

ä¸‹è½½å®‰è£…åŒ… [https://github.com/vernesong/OpenClash/releases](https://github.com/vernesong/OpenClash/releases)

æ‰“å¼€OpenWrtåå°æŒ‰ç…§å¦‚å›¾æ‰€ç¤ºçš„æ–¹æ³•å®‰è£…:

![image-20240613150044187](~public/assets/page-img/2024/20240613/2.webp)

### 3.2 é…ç½®

è¯ä¸å¤šè¯´ï¼Œç›´æ¥è·Ÿç€è§†é¢‘æ•™ç¨‹æ¥å§ ğŸ‘‰ [æ²¹ç®¡](https://youtu.be/s84CWgKus4U?t=48) ã€‚

### 3.3 è®¾ç½®SSHå’ŒHTTPS

#### 3.3.1 SSHå¯†é’¥

å–æ¶ˆè¿™ä¸¤ä¸ªçš„å‹¾é€‰ï¼Œç¦æ­¢ä½¿ç”¨å¯†ç ç™»é™†

![image-20240613194121754](~public/assets/page-img/2024/20240613/3.webp)

æ·»åŠ sshå¯†é’¥

![image-20240613194219045](~public/assets/page-img/2024/20240613/4.webp)

#### 3.3.2 HTTPS

OpenWrté»˜è®¤æ”¯æŒhttpsï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯è‡ªç­¾è¯ä¹¦ï¼Œè¿™é‡Œæ”¹æˆç”³è¯·çš„sslè¯ä¹¦

ä¸‹è½½è¯ä¹¦ï¼Œå°† `.key` å’Œ `.crt` æ ¼å¼çš„ä¸¤ä¸ªæ–‡ä»¶ä¸Šä¼ åˆ° OpenWrt ç³»ç»Ÿä¸­çš„ä»»æ„ä½ç½®ï¼Œä½†æ˜¯è¦è®°ä½ã€‚

ä½¿ç”¨ vim ä¿®æ”¹ `/etc/config/uhttpd` æ–‡ä»¶ï¼Œå°† `/etc/uhttpd.crt` å’Œ `/etc/uhttpd.key` ä¿®æ”¹æˆä½ ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤ `/etc/init.d/uhttpd restart` ï¼Œè¿™æ ·å°±ç®—å®Œæˆäº†ã€‚

## 4. åç»­

è‡³æ­¤ï¼ŒAll in one çš„ä¸¤ä¸ªæ ¸å¿ƒå°±ç®—å®‰è£…å¥½äº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯å®‰è£…å…¶å®ƒè™šæœºæœºï¼Œæ¯”å¦‚ Ubuntuã€Windwosç­‰ç­‰ã€‚

æˆ‘çš„æ€è·¯æ˜¯ï¼Œè½¯è·¯ç”±å°±å¥½å¥½å½“è½¯è·¯ç”±ï¼Œä¸åœ¨ä¸Šé¢æ­å»ºæœåŠ¡ã€‚å®‰è£…ä¸€å° Ubuntu Server å°†ä»¥å‰ [æ ‘è“æ´¾](https://www.meowpass.com/categories/?category=%E6%A0%91%E8%8E%93%E6%B4%BE) ä¸Šçš„æœåŠ¡è¿ç§»åˆ°ä¸Šé¢ã€‚

