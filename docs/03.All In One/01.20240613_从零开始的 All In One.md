---
title: 从零开始的 All In One
categories: 
  - All In One
tags: 
  - Linux
  - PVE
  - OpenWrt
  - SSH
  - SSL
  - fail2ban
meta: 
  - 
    name: description
    content: 从零开始的 All In One
  - 
    name: keywords
    content: Linux,PVE,OpenWrt,SSH,SSL,fail2ban,all-in-one,软路由,虚拟机
date: 2024-06-14 13:48:32
permalink: /pages/cec9e0/
---



我的All in one小主机是康耐信的n100，有四个网口，ETH0、ETH1、ETH2准备直通到OpenWrt中，ETH3作为PVE的管理口。

> 看前提示：本教程需要你会一点 Linux 基础，仅仅是对我这次折腾的一次记录，不太适合小白用户。

下面是一个大致的网络拓补图

![网络拓扑](~public/assets/page-img/2024/20240613/1.svg)

## 1. 安装PVE

### 1.1 安装

准备工作：

- 一个U盘（注意会被格式化）
- 下载PVE镜像，[下载地址](https://www.proxmox.com/en/downloads)
- 下载烧录软件，我用的是[balenaEtcher](https://etcher.balena.io/)

开始安装pve：具体过程参考这个B站视频 👉 [【利用PVE虚拟机，来打造属于自己的All In One系统吧！】 【精准空降到 02:06】](https://www.bilibili.com/video/BV1bc411v7A3/?t=126)

~~视频教程更加清晰明了，并不是因为我懒得写图文教程~~

<strong style='color: red'>⚠️注意：在视频的 [03:54](https://www.bilibili.com/video/BV1bc411v7A3/?share_source=copy_web&vd_source=aa6661a4ed1c3838fa877ec35742b580&t=234) 处，这里的DNS Server 要填一个有效的DNS服务器，不然后面PVE接入OpenWrt后还是上不了网，我这里填的 223.5.5.5</strong>

看到 <strong style='color: deepskyblue'>5分23秒</strong> 处即可结束，因为我后面要直通网卡到OpenWrt。

### 1.2 配置

#### 1.2.1 配置ssh

用 vim 编辑 `vim /etc/ssh/sshd_config` ，修改下面的几个配置：

```ssh
PasswordAuthentication no
PermitEmptyPasswords no
X11Forwarding no
PubkeyAuthentication yes
```

进入 `/root/.ssh` 目录，里面有 `id_rsa` 文件，下载到本地。

这样配置完成之后，pve的ssh就禁止使用密码登录，只能使用密钥连接了。

#### 1.2.2 配置fail2ban

安装fail2ban为ssh和pve管理后台登录开启登录保护。

```shell
apt update
apt install fail2ban
```

到这里会发现，安装了fail2ban之后，fail2ban无法启动，因为 Debian12 的缘故，需要调整一个地方的设置。

创建一个 `jail.local` 文件：

```shell
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
```

根据这个 [https://github.com/fail2ban/fail2ban/issues/3292#issuecomment-1142503461](https://github.com/fail2ban/fail2ban/issues/3292#issuecomment-1142503461) 来设置一下，然后执行 `systemctl restart fail2ban` 就可以了。

然后配置fail2ban为后台管理开启登录保护：

编辑 `/etc/fail2ban/jail.local` 文件在文件末尾写入：

```
[proxmox]
enabled = true
port = https,http,8006
filter = proxmox
backend = systemd
maxretry = 3
findtime = 2d
bantime = 1h
```

在用vim编辑 `vim /etc/fail2ban/filter.d/proxmox.conf` ，写入：

```
[Definition]
failregex = pvedaemon\[.*authentication failure; rhost=<HOST> user=.* msg=.*
ignoreregex =
journalmatch = _SYSTEMD_UNIT=pvedaemon.service
```

最后执行：

```
systemctl restart fail2ban
```

## 2. 安装OpenWrt

我用的是 koolcenter 编译的 [iStoreOS](https://fw.koolcenter.com/iStoreOS/) ，选择你主机对应的系统架构的镜像下载，我选的是 `x86_64_efi` 。

首先在PVE中创建OpenWrt虚拟机，参考视频依旧是上面那个视频 👉 [【利用PVE虚拟机，来打造属于自己的All In One系统吧！】 【精准空降到 05:47】](https://www.bilibili.com/video/BV1bc411v7A3/?t=347)

<strong style='color: red'>⚠️注意：本次教程我们用不到 "img2kvm" 这个脚本，只需要上传镜像文件即可，我们直接使用命令也能做到同样的效果</strong>

将镜像文件上传到pve中后我们执行下面这条命令：

```shell
qm importdisk <你的虚拟机id> <上传的镜像路径> local-lvm
```

导入成功后，继续按照视频中的教程设置虚拟磁盘和启动顺序。

## 3. OpenWrt中安装OpenClash

### 3.1 安装

安装所需依赖

```shell
opkg update && opkg install coreutils-nohup bash iptables dnsmasq-full curl ca-certificates ipset ip-full iptables-mod-tproxy iptables-mod-extra libcap libcap-bin ruby ruby-yaml kmod-tun kmod-inet-diag unzip luci-compat luci luci-base
```

下载安装包 [https://github.com/vernesong/OpenClash/releases](https://github.com/vernesong/OpenClash/releases)

打开OpenWrt后台按照如图所示的方法安装:

![image-20240613150044187](~public/assets/page-img/2024/20240613/2.webp)

### 3.2 配置

话不多说，直接跟着视频教程来吧 👉 [油管](https://youtu.be/s84CWgKus4U?t=48) 。

### 3.3 设置SSH和HTTPS

#### 3.3.1 SSH密钥

取消这两个的勾选，禁止使用密码登陆

![image-20240613194121754](~public/assets/page-img/2024/20240613/3.webp)

添加ssh密钥

![image-20240613194219045](~public/assets/page-img/2024/20240613/4.webp)

#### 3.3.2 HTTPS

OpenWrt默认支持https，但是使用的是自签证书，这里改成申请的ssl证书

下载证书，将 `.key` 和 `.crt` 格式的两个文件上传到 OpenWrt 系统中的任意位置，但是要记住。

使用 vim 修改 `/etc/config/uhttpd` 文件，将 `/etc/uhttpd.crt` 和 `/etc/uhttpd.key` 修改成你上传的文件路径，然后执行命令 `/etc/init.d/uhttpd restart` ，这样就算完成了。

## 4. 后续

至此，All in one 的两个核心就算安装好了。接下来就是安装其它虚机机，比如 Ubuntu、Windwos等等。

我的思路是，软路由就好好当软路由，不在上面搭建服务。安装一台 Ubuntu Server 将以前 [树莓派](https://www.meowpass.com/categories/?category=%E6%A0%91%E8%8E%93%E6%B4%BE) 上的服务迁移到上面。

