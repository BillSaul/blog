---
title: ä»é›¶å¼€å§‹çš„ All In One
author:
  name: è–„è·å±‹
  url: https://www.meowpass.com
category: 
  - All In One
tag: 
  - Linux
  - PVE
  - OpenWrt
  - SSH
  - SSL
  - fail2ban
head:
  - [meta, { name: keywords , content: "Linux,PVE,OpenWrt,SSH,SSL,fail2ban,all-in-one,è½¯è·¯ç”±,è™šæ‹Ÿæœº" }]
date: 2024-06-14 13:48:32
permalink: /pages/cec9e0/
---



æˆ‘çš„All in oneå°ä¸»æœºæ˜¯åº·è€ä¿¡çš„n100ï¼Œæœ‰å››ä¸ªç½‘å£ï¼ŒETH0ã€ETH1ã€ETH2å‡†å¤‡ç›´é€šåˆ°OpenWrtä¸­ï¼ŒETH3ä½œä¸ºPVEçš„ç®¡ç†å£ã€‚

::: tip çœ‹å‰æç¤º
æœ¬æ•™ç¨‹éœ€è¦ä½ ä¼šä¸€ç‚¹ Linux åŸºç¡€ï¼Œä»…ä»…æ˜¯å¯¹æˆ‘è¿™æ¬¡æŠ˜è…¾çš„ä¸€æ¬¡è®°å½•ï¼Œä¸å¤ªé€‚åˆå°ç™½ç”¨æˆ·ã€‚
:::


<!-- more -->

::: info
å†æ¬¡é˜…è¯»è‡ªå·±å†™çš„è¿™ç¯‡æ–‡ç« ï¼Œæ„Ÿè§‰å†™çš„å¾ˆä¹±ã€‚æ‰€ä»¥æœ¬ç¯‡æ–‡ç« å·²äº 2024å¹´09æœˆ03æ—¥ é‡æ–°å†™äº†ä¸€éã€‚
:::

ä¸‹é¢æ˜¯ä¸€ä¸ªå¤§è‡´çš„ç½‘ç»œæ‹“è¡¥å›¾

![](/assets/page-img/2024/20240613/1.svg)

## 1. å®‰è£…PVE

### 1.1 å®‰è£…

å‡†å¤‡å·¥ä½œï¼š

- ä¸€ä¸ªUç›˜ï¼ˆæ³¨æ„ä¼šè¢«æ ¼å¼åŒ–ï¼‰
- ä¸‹è½½PVEé•œåƒï¼Œ[ä¸‹è½½åœ°å€](https://www.proxmox.com/en/downloads)
- ä¸‹è½½çƒ§å½•è½¯ä»¶ï¼Œæˆ‘ç”¨çš„æ˜¯[balenaEtcher](https://etcher.balena.io/)

å¼€å§‹å®‰è£…pveï¼šå…·ä½“è¿‡ç¨‹å‚è€ƒè¿™ä¸ªBç«™è§†é¢‘ ğŸ‘‰ [ã€åˆ©ç”¨PVEè™šæ‹Ÿæœºï¼Œæ¥æ‰“é€ å±äºè‡ªå·±çš„All In Oneç³»ç»Ÿå§ï¼ã€‘ ã€ç²¾å‡†ç©ºé™åˆ° 02:06ã€‘](https://www.bilibili.com/video/BV1bc411v7A3/?t=126)

çœ‹åˆ° <strong style='color: deepskyblue'>5åˆ†23ç§’</strong> å¤„å³å¯ç»“æŸï¼Œå› ä¸ºæˆ‘åé¢è¦ç›´é€šç½‘å¡åˆ°OpenWrtã€‚

<strong style='color: red'>æ³¨æ„ï¼šåœ¨è§†é¢‘çš„ [03:54](https://www.bilibili.com/video/BV1bc411v7A3/?share_source=copy_web&vd_source=aa6661a4ed1c3838fa877ec35742b580&t=234) å¤„ï¼Œè¿™é‡Œçš„DNS Server è¦å¡«ä¸€ä¸ªæœ‰æ•ˆçš„DNSæœåŠ¡å™¨ï¼Œä¸ç„¶åé¢PVEæ¥å…¥OpenWrtåè¿˜æ˜¯ä¸Šä¸äº†ç½‘ï¼Œæˆ‘è¿™é‡Œå¡«çš„ 223.5.5.5</strong>

~~è§†é¢‘æ•™ç¨‹æ›´åŠ æ¸…æ™°æ˜äº†ï¼Œå¹¶ä¸æ˜¯å› ä¸ºæˆ‘æ‡’å¾—å†™å›¾æ–‡æ•™ç¨‹~~

### 1.2 ä¿®æ”¹é•œåƒä»“åº“

- å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://pve.proxmox.com/wiki/Package_Repositories#sysadmin_no_subscription_repo)ï¼Œç¼–è¾‘ `/etc/apt/sources.list` æ–‡ä»¶ï¼Œåˆ é™¤æ‰€æœ‰å†…å®¹ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

    ```
    deb https://ftp.debian.org/debian bookworm main contrib
    deb https://ftp.debian.org/debian bookworm-updates main contrib

    # Proxmox VE pve-no-subscription repository provided by proxmox.com,
    # NOT recommended for production use
    deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription

    # security updates
    deb https://security.debian.org/debian-security bookworm-security main contrib
    ```

- å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://pve.proxmox.com/wiki/Package_Repositories#sysadmin_enterprise_repo)ï¼Œç¼–è¾‘ `/etc/apt/sources.list.d/pve-enterprise.list` æ–‡ä»¶ï¼Œåœ¨è¡Œå¼€å¤´æ·»åŠ  `#` ç¦ç”¨ä»“åº“ï¼š

  ```
  # deb https://enterprise.proxmox.com/debian/pve bookworm pve-enterprise
  ```

- å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://pve.proxmox.com/wiki/Package_Repositories#_ceph_reef_no_subscription_repository)ï¼Œç¼–è¾‘ `/etc/apt/sources.list.d/ceph.list` æ–‡ä»¶ï¼Œåˆ é™¤æ‰€æœ‰å†…å®¹ï¼Œæ·»åŠ ä¸‹é¢å†…å®¹ï¼š

    ```
    deb http://download.proxmox.com/debian/ceph-quincy bookworm no-subscription
    ```

### 1.3 é…ç½®ssh

ç”¨ vim ç¼–è¾‘ `vim /etc/ssh/sshd_config` ï¼Œä¿®æ”¹ä¸‹é¢çš„å‡ ä¸ªé…ç½®ï¼š

```
PasswordAuthentication no
PermitEmptyPasswords no
X11Forwarding no
PubkeyAuthentication yes
```

è¿›å…¥ `/root/.ssh` ç›®å½•ï¼Œé‡Œé¢æœ‰ `id_rsa` æ–‡ä»¶ï¼Œä¸‹è½½åˆ°æœ¬åœ°ã€‚

è¿™æ ·é…ç½®å®Œæˆä¹‹åï¼Œpveçš„sshå°±ç¦æ­¢ä½¿ç”¨å¯†ç ç™»å½•ï¼Œåªèƒ½ä½¿ç”¨å¯†é’¥è¿æ¥äº†ã€‚

### 1.4 é…ç½®fail2ban

å®‰è£…fail2banä¸ºsshå’Œpveç®¡ç†åå°ç™»å½•å¼€å¯ç™»å½•ä¿æŠ¤ã€‚

```shell
apt update
apt install fail2ban
```

åˆ°è¿™é‡Œä¼šå‘ç°ï¼Œå®‰è£…äº†fail2banä¹‹åï¼Œfail2banæ— æ³•å¯åŠ¨ï¼Œå› ä¸º Debian12 çš„ç¼˜æ•…ï¼Œéœ€è¦è°ƒæ•´ä¸€ä¸ªåœ°æ–¹çš„è®¾ç½®ã€‚

åˆ›å»ºä¸€ä¸ª `jail.local` æ–‡ä»¶ï¼š

```shell
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
```

æ ¹æ®è¿™ä¸ª [https://github.com/fail2ban/fail2ban/issues/3292#issuecomment-1142503461](https://github.com/fail2ban/fail2ban/issues/3292#issuecomment-1142503461) æ¥è®¾ç½®ä¸€ä¸‹ï¼Œç„¶åæ‰§è¡Œ `systemctl restart fail2ban` å°±å¯ä»¥äº†ã€‚

å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://pve.proxmox.com/wiki/Fail2ban)ï¼Œé…ç½®fail2banä¸ºåå°ç®¡ç†å¼€å¯ç™»å½•ä¿æŠ¤ï¼š

```bash
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
```

ç¼–è¾‘ `/etc/fail2ban/jail.local` æ–‡ä»¶åœ¨æ–‡ä»¶æœ«å°¾å†™å…¥ï¼š

```
[proxmox]
enabled = true
port = https,http,8006
filter = proxmox
backend = systemd
maxretry = 3
findtime = 1d
bantime = 7d
```

ç¼–è¾‘ `/etc/fail2ban/filter.d/proxmox.conf` ï¼Œå†™å…¥ï¼š

```
[Definition]
failregex = pvedaemon\[.*authentication failure; rhost=<HOST> user=.* msg=.*
ignoreregex =
journalmatch = _SYSTEMD_UNIT=pvedaemon.service
```

æœ€åæ‰§è¡Œï¼š

```
systemctl restart fail2ban
```

### 1.5 æ˜¾ç¤ºç³»ç»Ÿæ›´å¤šä¿¡æ¯

å‚è€ƒ[æ©å±±æ— çº¿è®ºå›](https://www.right.com.cn/FORUM/forum.php?mod=viewthread&tid=6754687)å¸–å­ã€‚

### 1.6 æ ¸æ˜¾ç›´é€š

å†™äº†ä¸€ç¯‡å•ç‹¬çš„æ•™ç¨‹ï¼Œå‚è§[PVE8.2æ ¸æ˜¾ç›´é€šåˆ°Windows10](https://www.meowpass.com/pages/4bd3bc/)

<details>
<summary>SR-IOVæ–¹æ¡ˆï¼ˆåºŸå¼ƒï¼‰</summary>

**å¼€å¯ SR-IOV**

::: important 

ç”¨ç€ä¸èˆ’æœï¼Œåé¢æ”¹æˆç›´æ¥ç›´é€šæ•´ä¸ªæ ¸æ˜¾äº†ï¼Œå¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç«  [PVE8.2æ ¸æ˜¾ç›´é€šåˆ°Windows10](https://www.meowpass.com/pages/4bd3bc/)

:::

ä¸ºäº†å¼€å¯ `SR-IOV` ï¼Œæˆ‘ä»¬éœ€è¦åˆ‡æ¢å†…æ ¸ï¼Œå› ä¸ºæœ€æ–°ç‰ˆæœ¬çš„PVEä¸­ä½¿ç”¨çš„å†…æ ¸æ˜¯6.8ï¼Œä½†æ˜¯ [[i915-sriov-dkms](https://github.com/strongtz/i915-sriov-dkms)](https://github.com/strongtz/i915-sriov-dkms) åªæ”¯æŒåˆ°äº†6.5ã€‚

**å®‰è£…å†…æ ¸**

æ‰§è¡Œå‘½ä»¤ï¼š

```shell
apt install proxmox-kernel-6.5.11-8-pve-signed proxmox-headers-6.5.11-8-pve
```

ç„¶åå›ºå®šå†…æ ¸ç‰ˆæœ¬ï¼š

```
# æŸ¥çœ‹å·²å®‰è£…çš„å†…æ ¸
proxmox-boot-tool kernel list
## å¦‚æœåˆ—è¡¨ä¸­æ²¡æœ‰åˆšæ‰å®‰è£…çš„å†…æ ¸ï¼Œè¯·æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤
proxmox-boot-tool kernel add 6.5.11-8-pve
proxmox-boot-tool refresh

# å›ºå®šå†…æ ¸ç‰ˆæœ¬
proxmox-boot-tool kernel pin 6.5.11-8-pve
```

å¦‚æœè¦å–æ¶ˆå›ºå®šï¼Œå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼š`proxmox-boot-tool kernel unpin` ã€‚

**å¼€å¯**

å®‰è£…å¿…è¦çš„ä¾èµ–ï¼š

```shell
apt update
apt install mokutil sysfsutils build-* dkms
```

å…‹éš†ä»“åº“ï¼š

```
git clone https://github.com/strongtz/i915-sriov-dkms.git
cd i915-sriov-dkms
```

å¼€å§‹å®‰è£…

```
KERNEL=$(uname -r); KERNEL=${KERNEL%-pve}
cp -a dkms.conf{,.bak}
sed -i 's/"@_PKGBASE@"/"i915-sriov-dkms"/g' dkms.conf
sed -i 's/"@PKGVER@"/"'"$KERNEL"'"/g' dkms.conf
cat dkms.conf
dkms add .
cd /usr/src/i915-sriov-dkms-$KERNEL
dkms status
dkms install -m i915-sriov-dkms -v $KERNEL -k $(uname -r) --force
dkms status
lspci | grep VGA
# è¯·è®°å½•å½“å‰çš„æ ¸æ˜¾IDï¼Œä¿®æ”¹ä¸‹è¡Œçš„IDåæ‰§è¡Œä¸‹é¢çš„ä»£ç ã€‚
echo "devices/pci0000:00/0000:00:02.0/sriov_numvfs = 7" > /etc/sysfs.conf
cat /etc/sysfs.conf
mokutil --import /var/lib/dkms/mok.pub
æ³¨å†Œ MOKã€ç»§ç»­ã€æ˜¯ã€<å¯†ç >ã€é‡æ–°å¯åŠ¨
reboot

ç¼–è¾‘ /etc/default/grub æ–‡ä»¶ï¼Œåœ¨ quiet åæ·»åŠ  intel_iommu=on iommu=pt i915.enable_guc=3 i915.max_vfs=7

update-grub
update-initramfs -u
reboot
```

<strong style="color: #ff8c00">å¦‚æœä½¿ç”¨ Proxmox 8.1 æˆ–æ›´é«˜ç‰ˆæœ¬å¹¶å¯ç”¨å®‰å…¨å¯åŠ¨ï¼Œåˆ™å¿…é¡»è®¾ç½® MOKã€‚åœ¨ Proxmox ä¸»æœºé‡å¯æ—¶ï¼Œç›‘æ§å¯åŠ¨è¿‡ç¨‹å¹¶ç­‰å¾…æ‰§è¡Œ MOK ç®¡ç†çª—å£ï¼Œå‡ºç° MOK çª—å£ï¼Œéœ€è¦æŒ‰ä»»æ„é”®ç»§ç»­ï¼Œä¸ç„¶å°±è‡ªåŠ¨è·³è¿‡äº†ã€‚é€‰é¡¹ä¾æ¬¡ä¸ºï¼šEnroll MOKã€Continueã€Yesã€è¾“å…¥è®¾ç½®çš„å¯†ç ã€Rebootã€‚å¦‚æœé”™è¿‡äº†ç¬¬ä¸€æ¬¡é‡å¯ï¼Œåˆ™éœ€è¦é‡æ–°è¿è¡Œ mokutil å‘½ä»¤å¹¶å†æ¬¡é‡å¯ã€‚ä»¥åå°±ä¸å¿…äº†ï¼</strong>

å¼€å¯ SR-IOV çœŸçš„å¤ªæŠ˜è…¾äº†ğŸ˜­ï¼Œä¸‹æ¬¡ä¸æäº†ã€‚

</details>


## 2. å®‰è£…OpenWrt

æˆ‘ç”¨çš„æ˜¯ koolcenter ç¼–è¯‘çš„ [iStoreOS](https://fw.koolcenter.com/iStoreOS/) ï¼Œé€‰æ‹©ä½ ä¸»æœºå¯¹åº”çš„ç³»ç»Ÿæ¶æ„çš„é•œåƒä¸‹è½½ï¼Œæˆ‘é€‰çš„æ˜¯ `x86_64_efi` ã€‚

é¦–å…ˆåœ¨PVEä¸­åˆ›å»ºOpenWrtè™šæ‹Ÿæœºï¼Œå‚è€ƒè§†é¢‘ä¾æ—§æ˜¯ä¸Šé¢é‚£ä¸ªè§†é¢‘ ğŸ‘‰ [ã€åˆ©ç”¨PVEè™šæ‹Ÿæœºï¼Œæ¥æ‰“é€ å±äºè‡ªå·±çš„All In Oneç³»ç»Ÿå§ï¼ã€‘ ã€ç²¾å‡†ç©ºé™åˆ° 05:47ã€‘](https://www.bilibili.com/video/BV1bc411v7A3/?t=347)

<strong style='color: red'>æ³¨æ„ï¼šæœ¬æ¬¡æ•™ç¨‹æˆ‘ä»¬ç”¨ä¸åˆ° "img2kvm" è¿™ä¸ªè„šæœ¬ï¼Œåªéœ€è¦ä¸Šä¼ é•œåƒæ–‡ä»¶å³å¯ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨å‘½ä»¤ä¹Ÿèƒ½åšåˆ°åŒæ ·çš„æ•ˆæœ</strong>

å°†é•œåƒæ–‡ä»¶ä¸Šä¼ åˆ°pveä¸­åæˆ‘ä»¬æ‰§è¡Œä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š

```shell
qm importdisk <ä½ çš„è™šæ‹Ÿæœºid> <ä¸Šä¼ çš„é•œåƒè·¯å¾„> local-lvm
```

å¯¼å…¥æˆåŠŸåï¼Œç»§ç»­æŒ‰ç…§è§†é¢‘ä¸­çš„æ•™ç¨‹è®¾ç½®è™šæ‹Ÿç£ç›˜å’Œå¯åŠ¨é¡ºåºã€‚

### 2.1 é…ç½®SSH

å–æ¶ˆè¿™ä¸¤ä¸ªçš„å‹¾é€‰ï¼Œç¦æ­¢ä½¿ç”¨å¯†ç ç™»é™†

![](/assets/page-img/2024/20240613/3.webp)

æ·»åŠ sshå¯†é’¥

![](/assets/page-img/2024/20240613/4.webp)

### 2.2 é…ç½®HTTPS

OpenWrté»˜è®¤æ”¯æŒhttpsï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯è‡ªç­¾è¯ä¹¦ï¼Œè¿™é‡Œæ”¹æˆç”³è¯·çš„sslè¯ä¹¦

ä¸‹è½½è¯ä¹¦ï¼Œå°† `.key` å’Œ `.crt` æ ¼å¼çš„ä¸¤ä¸ªæ–‡ä»¶ä¸Šä¼ åˆ° OpenWrt ç³»ç»Ÿä¸­çš„ä»»æ„ä½ç½®ï¼Œä½†æ˜¯è¦è®°ä½ã€‚

ä½¿ç”¨ vim ä¿®æ”¹ `/etc/config/uhttpd` æ–‡ä»¶ï¼Œå°† `/etc/uhttpd.crt` å’Œ `/etc/uhttpd.key` ä¿®æ”¹æˆä½ ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„ï¼Œç„¶åæ‰§è¡Œå‘½ä»¤ `/etc/init.d/uhttpd restart` ï¼Œè¿™æ ·å°±ç®—å®Œæˆäº†ã€‚

## 3. å®‰è£…OpenClash

### 3.1 å®‰è£…

å®‰è£…æ‰€éœ€ä¾èµ–

```shell
opkg update && opkg install coreutils-nohup bash iptables dnsmasq-full curl ca-certificates ipset ip-full iptables-mod-tproxy iptables-mod-extra libcap libcap-bin ruby ruby-yaml kmod-tun kmod-inet-diag unzip luci-compat luci luci-base
```

ä¸‹è½½å®‰è£…åŒ… [https://github.com/vernesong/OpenClash/releases](https://github.com/vernesong/OpenClash/releases)

æ‰“å¼€OpenWrtåå°æŒ‰ç…§å¦‚å›¾æ‰€ç¤ºçš„æ–¹æ³•å®‰è£…:

![](/assets/page-img/2024/20240613/2.webp)

### 3.2 é…ç½®

è¯ä¸å¤šè¯´ï¼Œç›´æ¥è·Ÿç€è§†é¢‘æ•™ç¨‹æ¥å§ ğŸ‘‰ [æ²¹ç®¡](https://youtu.be/s84CWgKus4U?t=48) ã€‚

## 4. åç»­

è‡³æ­¤ï¼ŒAll in one çš„ä¸¤ä¸ªæ ¸å¿ƒå°±ç®—å®‰è£…å¥½äº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯å®‰è£…å…¶å®ƒè™šæœºæœºï¼Œæ¯”å¦‚ Debianã€Ubuntuã€Windwosç­‰ç­‰ã€‚æˆ‘çš„æ€è·¯æ˜¯ï¼Œè½¯è·¯ç”±å°±å¥½å¥½å½“è½¯è·¯ç”±ï¼Œä¸åœ¨ä¸Šé¢æ­å»ºæœåŠ¡ã€‚å‡†å¤‡å®‰è£…ä¸€å° Debian è™šæ‹Ÿæœºå°†ä»¥å‰ [æ ‘è“æ´¾](https://www.meowpass.com/categories/?category=%E6%A0%91%E8%8E%93%E6%B4%BE) ä¸Šçš„æœåŠ¡è¿ç§»åˆ°ä¸Šé¢ã€‚

